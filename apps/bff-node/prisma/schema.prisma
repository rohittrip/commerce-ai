generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("NODE_DATABASE_URL")
}

model addresses {
  id         String   @id
  user_id    String
  line1      String
  line2      String?
  city       String?
  state      String?
  pincode    String?
  country    String?  @default("IN")
  is_default Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  users      users    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  orders     orders[]

  @@index([user_id], map: "idx_addresses_user_id")
}

model admin_configs {
  key         String   @id
  category    String
  value       Json
  description String?
  updated_by  String?
  updated_at  DateTime @default(now()) @db.Timestamptz(6)

  @@index([category], map: "idx_admin_configs_category")
}

model admin_users {
  id            String   @id
  username      String   @unique
  password_hash String
  email         String?
  role          String   @default("admin")
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  status        String   @default("ACTIVE")

  @@index([username], map: "idx_admin_users_username")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model cart_items {
  cart_id    String
  product_id String
  provider   String?
  qty        Int
  unit_price Decimal? @db.Decimal(12, 2)
  metadata   Json     @default("{}")
  added_at   DateTime @default(now()) @db.Timestamptz(6)
  carts      carts    @relation(fields: [cart_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([cart_id, product_id])
}

model carts {
  id                String              @id
  user_id           String
  provider          String?
  status            String              @default("ACTIVE")
  currency          String              @default("INR")
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  updated_at        DateTime            @default(now()) @db.Timestamptz(6)
  cart_items        cart_items[]
  users             users               @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  orders            orders[]
  checkout_sessions checkout_sessions[]

  @@index([user_id], map: "idx_carts_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model chat_messages {
  id            String        @id
  session_id    String
  role          String
  content_text  String?
  content_json  Json          @default("{}")
  redacted_text String?
  created_at    DateTime      @default(now()) @db.Timestamptz(6)
  chat_sessions chat_sessions @relation(fields: [session_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  feedback      feedback[]
  tool_calls    tool_calls[]

  @@index([session_id, created_at], map: "idx_chat_messages_session_id")
}

model chat_sessions {
  id            String          @id
  user_id       String?
  locale        String?
  device_id     String?
  created_at    DateTime        @default(now()) @db.Timestamptz(6)
  updated_at    DateTime        @default(now()) @db.Timestamptz(6)
  chat_messages chat_messages[]
  users         users?          @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  feedback      feedback[]
  tool_calls    tool_calls[]

  @@index([created_at(sort: Desc)], map: "idx_chat_sessions_created_at")
  @@index([user_id], map: "idx_chat_sessions_user_id")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model feedback {
  id            String         @id
  session_id    String
  message_id    String?
  rating        Int
  reason        String?
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  chat_messages chat_messages? @relation(fields: [message_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  chat_sessions chat_sessions  @relation(fields: [session_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([session_id], map: "idx_feedback_session_id")
}

model idempotency_keys {
  key           String    @id
  user_id       String?
  scope         String
  request_hash  String
  response_json Json
  created_at    DateTime  @default(now()) @db.Timestamptz(6)
  expires_at    DateTime? @db.Timestamptz(6)

  @@index([expires_at], map: "idx_idempotency_keys_expires_at")
}

model order_events {
  id       String   @id
  order_id String
  status   String
  message  String?
  payload  Json     @default("{}")
  ts       DateTime @default(now()) @db.Timestamptz(6)
  orders   orders   @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([order_id, ts], map: "idx_order_events_order_id")
}

model orders {
  id                String         @id
  user_id           String
  cart_id           String?
  provider          String
  provider_order_id String?
  address_id        String?
  status            String
  payment_method    String         @default("COD")
  currency          String         @default("INR")
  total             Decimal        @default(0) @db.Decimal(12, 2)
  payment_url       String?
  created_at        DateTime       @default(now()) @db.Timestamptz(6)
  updated_at        DateTime       @default(now()) @db.Timestamptz(6)
  order_events      order_events[]
  addresses         addresses?     @relation(fields: [address_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  carts             carts?         @relation(fields: [cart_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users             users          @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_orders_created_at")
  @@index([status], map: "idx_orders_status")
  @@index([user_id], map: "idx_orders_user_id")
}

model providers {
  id                  String                @id
  name                String
  type                String
  base_url            String?
  api_key             String?
  enabled             Boolean               @default(true)
  config              Json                  @default("{}")
  field_mappings      Json                  @default("{}")
  category_mappings   Json                  @default("{}")
  capabilities        String[]              @default([])
  priority            Int?                  @default(0)
  created_at          DateTime              @default(now()) @db.Timestamptz(6)
  updated_at          DateTime              @default(now()) @db.Timestamptz(6)
  tool_configs        Json                  @default("{}")
  openapi_spec        Json?                 @default("{}")
  ucp_profile         Json?                 @default("{}")
  auth_type           String?               @default("none")
  oauth_config        Json?                 @default("{}")
  tool_schemas        tool_schemas[]
  provider_categories provider_categories[]

  @@index([enabled], map: "idx_providers_enabled")
  @@index([type], map: "idx_providers_type")
}

model categories {
  id                  String                @id
  name                String
  description         String?
  icon                String?
  display_order       Int                   @default(0)
  enabled             Boolean               @default(true)
  created_at          DateTime              @default(now()) @db.Timestamptz(6)
  provider_categories provider_categories[]

  @@index([enabled], map: "idx_categories_enabled")
  @@index([display_order], map: "idx_categories_order")
}

model provider_categories {
  provider_id String
  category_id String
  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  provider    providers  @relation(fields: [provider_id], references: [id], onDelete: Cascade)
  category    categories @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@id([provider_id, category_id])
  @@index([provider_id], map: "idx_provider_categories_provider")
  @@index([category_id], map: "idx_provider_categories_category")
}

model ucp_tools {
  id                       String   @id
  display_name             String
  description              String?
  category                 String   @default("commerce")
  enabled                  Boolean  @default(true)
  request_schema           Json     @default("{}")
  response_schema          Json     @default("{}")
  default_timeout_ms       Int      @default(30000)
  default_retry_count      Int      @default(3)
  default_retry_backoff_ms Int      @default(1000)
  auth_config              Json     @default("{}")
  version                  Int      @default(1)
  created_at               DateTime @default(now()) @db.Timestamptz(6)
  updated_at               DateTime @default(now()) @db.Timestamptz(6)

  @@index([category], map: "idx_ucp_tools_category")
  @@index([enabled], map: "idx_ucp_tools_enabled")
}

/// Custom JSON schemas per provider+tool combination for request/response validation
model tool_schemas {
  id             Int       @id @default(autoincrement())
  provider_id    String
  tool_name      String
  schema_type    String    // 'request' or 'response'
  schema_content Json
  version        Int       @default(1)
  is_custom      Boolean   @default(true)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  updated_at     DateTime  @default(now()) @db.Timestamptz(6)
  created_by     String?
  provider       providers @relation(fields: [provider_id], references: [id], onDelete: Cascade)

  @@unique([provider_id, tool_name, schema_type])
  @@index([provider_id, tool_name], map: "idx_tool_schemas_provider_tool")
  @@index([updated_at(sort: Desc)], map: "idx_tool_schemas_updated_at")
}

model tool_calls {
  id            String         @id
  session_id    String
  message_id    String?
  tool_name     String
  request_json  Json
  response_json Json
  success       Boolean
  duration_ms   Int?
  trace_id      String?
  created_at    DateTime       @default(now()) @db.Timestamptz(6)
  provider_id   String?
  cached        Boolean        @default(false)
  is_internal   Boolean        @default(false)
  chat_messages chat_messages? @relation(fields: [message_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  chat_sessions chat_sessions  @relation(fields: [session_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([created_at(sort: Desc)], map: "idx_tool_calls_created_at")
  @@index([provider_id], map: "idx_tool_calls_provider_id")
  @@index([session_id], map: "idx_tool_calls_session_id")
  @@index([tool_name], map: "idx_tool_calls_tool_name")
}

model user_preferences {
  user_id     String   @id
  preferences Json     @default("{}")
  updated_at  DateTime @default(now()) @db.Timestamptz(6)
  users       users    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model users {
  id                String              @id
  username          String?             @unique
  password_hash     String?
  phone_hash        String?
  email_hash        String?
  role              String              @default("customer")
  created_at        DateTime            @default(now()) @db.Timestamptz(6)
  status            String              @default("ACTIVE")
  addresses         addresses[]
  carts             carts[]
  chat_sessions     chat_sessions[]
  orders            orders[]
  user_preferences  user_preferences?
  checkout_sessions checkout_sessions[]

  @@index([username], map: "idx_users_username")
}

model checkout_sessions {
  id               String   @id
  user_id          String
  cart_id          String?
  provider         String
  status           String   // CREATED, SHIPPING_SET, PAYMENT_SET, COMPLETED, CANCELLED, EXPIRED
  items            Json     // Snapshot of cart items (freeze prices at checkout time)
  shipping_address Json?
  billing_address  Json?
  payment_method   String?
  payment_details  Json?
  subtotal         Decimal  @db.Decimal(12, 2)
  tax              Decimal  @db.Decimal(12, 2)
  shipping_cost    Decimal  @db.Decimal(12, 2)
  discount         Decimal  @default(0) @db.Decimal(12, 2)
  total            Decimal  @db.Decimal(12, 2)
  currency         String   @default("INR")
  expires_at       DateTime @db.Timestamptz(6)
  created_at       DateTime @default(now()) @db.Timestamptz(6)
  updated_at       DateTime @default(now()) @db.Timestamptz(6)
  users            users    @relation(fields: [user_id], references: [id])
  carts            carts?   @relation(fields: [cart_id], references: [id])

  @@index([user_id], map: "idx_checkout_sessions_user_id")
  @@index([status], map: "idx_checkout_sessions_status")
  @@index([expires_at], map: "idx_checkout_sessions_expires_at")
}

model coupons {
  code         String    @id
  type         String    // PERCENTAGE, FIXED_AMOUNT
  value        Decimal   @db.Decimal(12, 2)
  min_order    Decimal?  @db.Decimal(12, 2)
  max_discount Decimal?  @db.Decimal(12, 2)
  expires_at   DateTime  @db.Timestamptz(6)
  enabled      Boolean   @default(true)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  description  String?

  @@index([enabled], map: "idx_coupons_enabled")
  @@index([expires_at], map: "idx_coupons_expires_at")
}
